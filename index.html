<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Glow AI - Код Красоты</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Lato', sans-serif;
        background-color: #FFF0F5; /* Lavender Blush */
      }
      h1, h2, h3, .font-serif {
        font-family: 'Playfair Display', serif;
      }
      .glass-modal {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "@google/genai": "https://esm.sh/@google/genai@^1.34.0",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
    "@vitejs/plugin-react": "https://esm.sh/@vitejs/plugin-react@^5.1.2",
    "vite": "https://esm.sh/vite@^7.3.0"
  }
}
</script>
</head>
  <body>
    <div id="root"></div>

    <!-- Subscription Gate Modal -->
    <div id="subscription-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm transition-opacity duration-500 opacity-0 pointer-events-none" style="display: none;">
      <div class="glass-modal p-8 rounded-3xl shadow-2xl max-w-sm w-[90%] mx-auto text-center border border-rose-200 transform scale-95 transition-transform duration-500" id="modal-card">
        
        <div class="flex justify-center mb-6">
          <div class="bg-rose-100 p-4 rounded-full relative">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-rose-600">
              <rect width="18" height="11" x="3" y="11" rx="2" ry="2"/>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
            </svg>
            <div class="absolute -top-1 -right-1">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="#fb7185" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/>
              </svg>
            </div>
          </div>
        </div>

        <h2 class="text-2xl font-serif font-bold text-stone-800 mb-3">
          Секрет Красоты
        </h2>
        <p class="text-stone-600 mb-8 font-light leading-relaxed">
          Чтобы открыть доступ к ИИ-анализу вашей внешности, подпишитесь на наш канал.
        </p>

        <div class="space-y-3">
          <button id="btn-subscribe" class="w-full py-3.5 px-6 bg-rose-500 hover:bg-rose-600 text-white rounded-xl font-medium transition-all shadow-lg shadow-rose-200 transform hover:-translate-y-0.5 flex items-center justify-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
            Подписаться
          </button>
          
          <button id="btn-check" class="w-full py-3.5 px-6 bg-white border border-rose-200 text-rose-600 hover:bg-rose-50 rounded-xl font-medium transition-colors">
            Проверить подписку
          </button>
        </div>
      </div>
    </div>

    <script type="module" src="/index.tsx"></script>

    <script>
      // Configuration
      const TELEGRAM_CHANNEL_LINK = "https://t.me/groupaifaily"; 
      const TELEGRAM_CHANNEL_ID = "-1003657083355";

      window.addEventListener('load', async () => {
        const modal = document.getElementById('subscription-modal');
        const modalCard = document.getElementById('modal-card');
        const btnSubscribe = document.getElementById('btn-subscribe');
        const btnCheck = document.getElementById('btn-check');

        // Initialize Telegram WebApp
        const tg = window.Telegram?.WebApp;
        if (tg) {
          tg.ready();
          tg.expand();
        }

        const userId = tg?.initDataUnsafe?.user?.id;
        
        // Show modal helper
        const showModal = () => {
          modal.style.display = 'flex';
          // Force reflow
          modal.offsetHeight; 
          modal.classList.remove('opacity-0', 'pointer-events-none');
          modalCard.classList.remove('scale-95');
          modalCard.classList.add('scale-100');
        };

        // Hide modal helper
        const hideModal = () => {
          modal.classList.add('opacity-0', 'pointer-events-none');
          modalCard.classList.add('scale-95');
          modalCard.classList.remove('scale-100');
          setTimeout(() => {
            modal.style.display = 'none';
          }, 500);
        };

        const checkSubscription = async () => {
          if (!userId) {
            console.warn("No Telegram User ID found. Showing modal for testing.");
            // Если нет ID пользователя (открыто в браузере), блокируем для безопасности.
            // Для разработки можно временно закомментировать строку ниже.
            showModal();
            return;
          }

          // Visual loading state on check button
          const originalBtnText = btnCheck.innerText;
          btnCheck.innerText = "Проверяем...";
          btnCheck.disabled = true;

          try {
            // Передаем также channel_id, чтобы API знало, какой канал проверять
            const res = await fetch(`/api/check-subscription?user_id=${userId}&channel_id=${TELEGRAM_CHANNEL_ID}`);
            const data = await res.json();

            if (data.subscribed) {
              hideModal();
            } else {
              showModal();
            }
          } catch (e) {
            console.error("Check failed", e);
            // При ошибке (нет интернета и т.д.) показываем модальное окно
            showModal();
          } finally {
            btnCheck.innerText = originalBtnText;
            btnCheck.disabled = false;
          }
        };

        // Event Handlers
        btnSubscribe.addEventListener('click', () => {
          if (tg && tg.openTelegramLink) {
            tg.openTelegramLink(TELEGRAM_CHANNEL_LINK);
          } else {
            window.open(TELEGRAM_CHANNEL_LINK, '_blank');
          }
        });

        btnCheck.addEventListener('click', () => {
          checkSubscription();
        });

        // Initial Check
        checkSubscription();
      });
    </script>
  </body>
</html>